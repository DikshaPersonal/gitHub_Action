name: Build and Deploy Android Project for Capacitor

on:
  push:
    branches:
      - github_action

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install
          npm install --save @capacitor/android

      - name: Build web assets
        run: |
          npm run build # Ensure your web assets are built and stored in ./www (default)

      - name: Sync Capacitor Android platform
        run: |
          npx cap sync android

      - name: Build Android app (Capacitor)
        run: |
          # Navigate to the Android directory where gradlew is located
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Install rclone
        run: |
          sudo apt-get install rclone
          mkdir -p ~/.config/rclone

      - name: Configure rclone with Google Service Account
        run: |
          echo "$GOOGLE_DRIVE_CREDENTIALS" > /tmp/sa.json
          echo '[gdrive]
          type = drive
          scope = drive
          service_account_file = /tmp/sa.json' > ~/.config/rclone/rclone.conf

      - name: Set dummy subdomain for testing
        run: |
          # Hardcoding a dummy subdomain value
          SUBDOMAIN="dummySubdomain"
          echo "SUBDOMAIN=$SUBDOMAIN" >> $GITHUB_ENV

      - name: Upload to Google Drive
        run: |
          folder_id="1Dm9WcPG8OBlQ2FDvzHFsBHm-uUV1TKN3"
          timestamp=$(date +%Y_%m_%d)
          # Use the dummy subdomain to rename APK
          mv android/app/build/outputs/apk/debug/app-debug.apk android/app/build/outputs/apk/debug/${SUBDOMAIN}-${timestamp}.apk
          rclone copy --verbose android/app/build/outputs/apk/debug/${SUBDOMAIN}-${timestamp}.apk gdrive:/ --drive-root-folder-id $folder_id

      - name: Upload debug APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SUBDOMAIN }}-debug
          path: android/app/build/outputs/apk/debug/*.apk
